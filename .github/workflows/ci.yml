# ============================================================
# .github/workflows/ci.yml
# Place this file at: .github/workflows/ci.yml
# in your qasm2python repo
# ============================================================
#
# This workflow does 4 things automatically:
#   1. LINT    — check code style with flake8
#   2. TEST    — run pytest on Python 3.9, 3.10, 3.11, 3.12
#   3. REVIEW  — Claude AI reviews every Pull Request
#   4. PUBLISH — auto-publish to PyPI when you push a version tag
#
# SETUP (one time):
#   Go to GitHub → your repo → Settings → Secrets → Actions
#   Add these secrets:
#     ANTHROPIC_API_KEY  → your Anthropic key (for Claude review)
#     PYPI_API_TOKEN     → your PyPI token   (for auto-publish)
# ============================================================

name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]          # triggers PyPI publish on version tags
  pull_request:
    branches: [main]

jobs:

  # ────────────────────────────────────────────────────────
  # JOB 1: Lint
  # ────────────────────────────────────────────────────────
  lint:
    name: Lint (flake8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8
        run: |
          flake8 qasm2python/ \
            --max-line-length=100 \
            --ignore=E501,W503,E302,E303,E402 \
            --statistics

  # ────────────────────────────────────────────────────────
  # JOB 2: Test matrix (Python 3.9 → 3.12)
  # ────────────────────────────────────────────────────────
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package + test deps
        run: |
          pip install -e ".[dev]"
          pip install pytest pytest-cov

      - name: Run pytest
        run: |
          pytest tests/ -v \
            --cov=qasm2python \
            --cov-report=term-missing \
            --tb=short

  # ────────────────────────────────────────────────────────
  # JOB 3: Claude AI Code Review (runs on Pull Requests only)
  # ────────────────────────────────────────────────────────
  claude-review:
    name: Claude AI Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: lint

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0    # need full history to get the diff

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Anthropic SDK
        run: pip install anthropic

      - name: Get PR diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD \
            -- '*.py' > pr_diff.txt
          echo "diff_lines=$(wc -l < pr_diff.txt)" >> $GITHUB_OUTPUT

      - name: Run Claude review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python - <<'EOF'
          import anthropic, sys, json, os

          diff = open("pr_diff.txt").read()
          if not diff.strip():
              print("No Python changes to review.")
              sys.exit(0)

          client = anthropic.Anthropic()
          response = client.messages.create(
              model="claude-opus-4-6",
              max_tokens=1024,
              messages=[{
                  "role": "user",
                  "content": f"""You are reviewing a Pull Request for the qasm2python package.
          This package converts OpenQASM 2.0/3.0 code into Qiskit Python code.

          Review the following git diff and provide:
          1. A brief summary of what changed
          2. Any bugs or logic errors
          3. Any issues specific to QASM parsing or Qiskit circuit generation
          4. Code quality suggestions
          5. Overall verdict: APPROVE or REQUEST_CHANGES

          Git diff:
          ```
          {diff[:6000]}
          ```

          Keep your review concise and actionable."""
              }]
          )

          review = response.content[0].text
          print("=" * 60)
          print("CLAUDE CODE REVIEW")
          print("=" * 60)
          print(review)
          print("=" * 60)

          # Fail the CI if Claude recommends changes
          if "REQUEST_CHANGES" in review.upper():
              print("\n⚠️  Claude recommends changes — marking as failed.")
              sys.exit(1)
          else:
              print("\n✅  Claude approved the PR.")
          EOF

  # ────────────────────────────────────────────────────────
  # JOB 4: Publish to PyPI (only on version tags like v1.2.3)
  # ────────────────────────────────────────────────────────
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        run: python -m build

      - name: Check dist
        run: twine check dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*
