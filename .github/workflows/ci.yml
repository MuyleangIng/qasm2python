# ============================================================
# .github/workflows/ci.yml
# ============================================================
# This workflow does 4 things automatically:
#   1. LINT      â€” check code style with flake8
#   2. TEST      â€” run pytest on Python 3.9, 3.10, 3.11, 3.12
#   3. AUTO-FIX  â€” Claude reads changed files, fixes style/docs,
#                  and commits the fixes back to your PR branch
#   4. PUBLISH   â€” auto-publish to PyPI on version tags (v1.2.3)
#
# SECRETS needed (Settings â†’ Secrets â†’ Actions â†’ Repository secrets):
#   ANTHROPIC_API_KEY  â†’ your Anthropic key
#   PYPI_API_TOKEN     â†’ your PyPI token
# ============================================================

name: CI/CD

on:
  push:
    branches: [main]
    tags: ["v*.*.*"]
  pull_request:
    branches: [main]

jobs:

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Lint
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Lint (flake8)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install flake8
        run: pip install flake8

      - name: Run flake8
        run: |
          flake8 qasm2python/ \
            --max-line-length=100 \
            --ignore=E501,W503,E302,E303,E402 \
            --statistics

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Test matrix (Python 3.9 â†’ 3.12)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: Test (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: lint

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install package + test deps
        run: |
          pip install -e ".[dev]"
          pip install pytest pytest-cov qiskit qiskit_qasm3_import

      - name: Run pytest
        run: |
          pytest tests/ -v \
            --cov=qasm2python \
            --cov-report=term-missing \
            --tb=short

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Claude AI Auto-Fix + Commit (PR only)
  # Claude reads every changed .py file, fixes style/docs,
  # then commits the fixes back to your PR branch automatically
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  claude-autofix:
    name: Claude AI Auto-Fix
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: lint
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Anthropic SDK
        run: pip install anthropic

      - name: Get changed Python files
        run: |
          git diff origin/${{ github.base_ref }}...HEAD \
            --name-only -- '*.py' > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt

      - name: Claude auto-fix changed files
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python - <<'EOF'
          import anthropic, sys, os

          client = anthropic.Anthropic()
          changed = open("changed_files.txt").read().strip().splitlines()

          if not changed:
              print("No Python files changed â€” nothing to fix.")
              sys.exit(0)

          any_fixed = False

          for filepath in changed:
              if not os.path.exists(filepath):
                  print(f"Skipping {filepath} (deleted)")
                  continue

              original = open(filepath).read()
              print(f"\n{'='*60}\nReviewing: {filepath}\n{'='*60}")

              response = client.messages.create(
                  model="claude-opus-4-6",
                  max_tokens=4096,
                  messages=[{
                      "role": "user",
                      "content": f"""You are an expert Python code fixer for the qasm2python package.
          This package converts OpenQASM 2.0/3.0 into executable Qiskit Python code.

          Fix the following Python file. Apply ALL of these fixes:
          - PEP 8: exactly 2 blank lines between top-level functions/classes
          - PEP 8: all imports must be at the very top of the file
          - PEP 8: max line length 100 chars
          - Add or improve docstrings on functions that are missing them
          - Fix any obvious bugs or logic errors
          - Do NOT change any logic or behaviour â€” only style and doc fixes

          Return ONLY the complete fixed Python file contents.
          Do NOT include any explanation, markdown fences, or commentary.
          Return raw Python code only.

          File: {filepath}
          Contents:
          {original}"""
                  }]
              )

              fixed = response.content[0].text.strip()

              # Strip accidental markdown fences
              if fixed.startswith("```python"):
                  fixed = fixed[len("```python"):].lstrip("\n")
              if fixed.startswith("```"):
                  fixed = fixed[3:].lstrip("\n")
              if fixed.endswith("```"):
                  fixed = fixed[:-3].rstrip("\n")

              if fixed != original:
                  open(filepath, "w").write(fixed + "\n")
                  print(f"  âœ… Fixed: {filepath}")
                  any_fixed = True
              else:
                  print(f"  âœ“  No changes needed: {filepath}")

          if any_fixed:
              open("autofix_needed.txt", "w").write("yes")
              print("\nðŸ“ Fixes ready to commit.")
          else:
              print("\nâœ“ All files already clean.")
          EOF

      - name: Commit fixes back to PR branch
        run: |
          if [ -f autofix_needed.txt ]; then
            git config user.name  "Claude AI"
            git config user.email "claude-ai@anthropic.com"
            git add -A
            git commit -m "fix(auto): Claude AI style and docstring fixes"
            git push origin HEAD:${{ github.head_ref }}
            echo "âœ… Claude's fixes committed and pushed to PR branch."
          else
            echo "âœ“ Nothing to commit â€” code was already clean."
          fi

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 4: Publish to PyPI (version tags only e.g. v1.2.3)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: [test]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tools
        run: pip install build twine

      - name: Build package
        run: python -m build

      - name: Check dist
        run: twine check dist/*

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: twine upload dist/*